---
title: "Technical Report"
author: "Martin Glusker, Nicole Frontero, Oliver Baldwin-Edwards"
date: 'Due: 12/18/18'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(httr)
library(rvest)
library(readxl)
library(tidyverse)
library(mdsr)   
library(tidyr)
library(ggplot2)
library(readr)
library(knitr)
library(roxygen2)#needed for gluskr documentation
library(rpart)
options(warn=-1)
```

## Abstract:

This project seeks to better understand the relationship between GDP per capita and transit in micropolitan and metropolitan areas in the United States.  While the original intention was to create a quality of life score or statistic utilizing multiple variables to see how a city's transit may predict that score, this is beyond the scope of this project (see introduction for an elaboration of motivation behind altering project scope).  Upon such a realization, it was decided to pivot to explore how well transit statistics can predict gdp in U.S. micropolitan and metropolitan areas.  IT WAS FOUND THAT...

## Introduction:

The research question at hand is if a U.S. metropolitan or micropolitan area's transit system can predict the GDP of that area.  This question is interesting because, as GDP is a valued metric of a city's well-being, understanding the relationship between GDP and a city's transit may shed insight on how to possibly increase GDP. 

It's important to note that the question stated above was not the initial question that the researchers sought to address.  In fact, the researchers initially wanted to analyze the relationship between a city's transit system and the quality of life in that city.  However, this question presented various difficulties.  For example, creating a model that predicted various response variables pertaining to quality of life would prove to be beyond the scope of the researchers' capabilities.  An alternative option for predicting quality of life for a given city would be to utilize only one variable as a response variable.  However, this would necessitate a reframing of the question at hand, as choosing one variable to represent quality of life at large would be misleading.  To resolve these problems, the researchers decided to alter the research question to ask the question "how a city's transit system predict the GDP per capita of that city".  The researchers decided upon GDP per capita as a response variable to analyze because generally speaking, it is a broad metric of the health of a city's economy.  The researchers selected GDP per capita specifically to avoid population of a city skewing the GDP.  

In order to answer this question, one large dataframe had to be created that combined gdp and transit system information by metropolitan and micropolitan statistic areas.  This dataframe can be accessed via the R package, "gluskr" created during the course of this project. A readme is available for this package.  

With this dataframe, it was possible to ... FINISH THIS.

## Data:
The final_df represents a compilation of quality of life related variables and transit related variables by metropolitan and micropolitan statistica areas in the U.S. between 2007 and 2017. 

For a more detailed explanation of where these data came from and what each variable name stands for, consult the readme.  

Within this "data" section, there are subsections.  The first is "Quality of Life Data", pertaining to variables that came from the U.S. Census and the Bureau of Economic Analysis.  The second is the "Transit Data" section, which includes all variables derived from the FTA/National Transit Database.  Then, there is...INCLUDE ADDITIONAL SECTIONS HERE.

## Quality of Life Data

### Read in GDP Data
This returns a dataframe with gdp for each metropolitan and micropolitan statistical area from the U.S. census from years 2001-2017.
```{r, messages=FALSE}

gdp_df <- read_xls("../quality-of-life-data/gdp/gdp-industrytotal.xls", 
                   sheet = 1, range = 'A6:S390', col_names=TRUE) %>% 
  gather(key = "Year", value = "gdp", -c("GeoFips", "GeoName")) %>% 
  mutate("GEO.id2" = as.integer(GeoFips), "Year" = as.double(Year)) %>% 
  select(GEO.id2, GeoName, Year, gdp) 

```

### Read in Latitude Longitude Data
This returns a dataset with latitudinal and longitudinal coordinates for each metropolitan and micropolitan statistical area. 
```{r, messages=FALSE}

# coordinates for metropolitan areas
metropolitan_coordinates <- read_xlsx(
  "../quality-of-life-data/latitude-longitude/StatisticalAreasLatLong.xlsx",
  sheet = 1, range = "A2:Q376", col_names = TRUE)

# coordinates for micropolitan areas
micropolitan_coordinates <- read_xlsx(
  "../quality-of-life-data/latitude-longitude/StatisticalAreasLatLong.xlsx",
  sheet = 2, range = "A2:Q583", col_names = TRUE)

# combine metropolitan and micropolitan areas
lat_long_df <- rbind(metropolitan_coordinates, micropolitan_coordinates) %>%
  mutate("GEO.id2" = GEOID, "GEO.display-label" = NAME) %>%
  arrange(NAME) %>%
  select(GEO.id2, `GEO.display-label`, CENTLAT, CENTLON, INTPTLAT, INTPTLON)

```

### Read in Population Data
This code chunk reads in the population estimates from the U.S. Census Bureau from 2007 to 2017 and joins these separate tables into one table.  
```{r, messages=FALSE, warning=FALSE}

# function to read in population DFs efficiently 
read_population_df <- function(file_name, year) {
  
  df <- read_csv(file_name) 
  
  colnames(df)[4] <- "PopEstimate" 
  colnames(df)[5] <- "MOE" 
  df <- df %>% 
    mutate("Year" = year) %>% 
    select(-MOE)
  
  return(df)
}

# read in population data for years 2007 through 2017
pop_2007 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2007/ACS_07_1YR_B01003.csv', 2007))
pop_2008 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2008/ACS_08_1YR_B01003.csv', 2008))
pop_2009 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2009/ACS_09_1YR_B01003.csv', 2009))
pop_2010 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2010/ACS_10_1YR_B01003.csv', 2010))
pop_2011 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2011/ACS_11_1YR_B01003.csv', 2011))
pop_2012 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2012/ACS_12_1YR_B01003.csv', 2012))
pop_2013 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2013/ACS_13_1YR_B01003.csv', 2013))
pop_2014 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2014/ACS_14_1YR_B01003.csv', 2014))
pop_2015 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2015/ACS_15_1YR_B01003.csv', 2015))
pop_2016 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2016/ACS_16_1YR_B01003.csv', 2016))
pop_2017 <- suppressMessages(read_population_df(
  '../quality-of-life-data/population/2017/ACS_17_1YR_B01003.csv', 2017))


# join all years into one dataframe
suppressMessages(
population_df <- full_join(pop_2007, pop_2008) %>%
  full_join(pop_2009) %>%
  full_join(pop_2010) %>%
  full_join(pop_2011) %>%
  full_join(pop_2012) %>%
  full_join(pop_2013) %>%
  full_join(pop_2014) %>%
  full_join(pop_2015) %>%
  full_join(pop_2016) %>%
  full_join(pop_2017))
```

### Read in Census Quality of Life Data
This dataframe takes a number of quality of life related variables from 2007-2009 and takes in the same variables as well as "percent no health insurance coverage".  Then, it joins the data sets to create one comprehensive dataframe.  
```{r, messages=FALSE, warnings=FALSE}

# function to clean up data frames from 2007-2009
# (the census changed variable names after 2009)
clean_data_2007_2009 <- function(file_name, year) {
  df <- read_csv(file_name) %>% 
    mutate('Median household income (dollars)' = HC01_EST_VC69,
           'Percent workers commuting by public transportation' = HC02_EST_VC23,
           'Percent population unemployed' = HC02_EST_VC06,
           'Year' = year) %>% 
     select(Year, GEO.id, GEO.id2, `GEO.display-label`, 
           `Median household income (dollars)`, 
           `Percent workers commuting by public transportation`,
           `Percent population unemployed`)
  return(df)
}

# function to clean up data frames from 2010-2017
clean_data_2010_2017 <- function(file_name, year) {
  df <- read_csv(file_name) %>% 
    mutate('Median household income (dollars)' = HC01_VC85,
           'Percent workers commuting by public transportation' = HC03_VC31,
           'Percent population unemployed' = HC03_VC08,
           'Percent no health insurance coverage' = HC03_VC134,
          
            # for all people 18 years and older:
           'Percent income below poverty level' = as.numeric(HC03_VC171),
           'Year' = year ) %>% 
     select(Year, GEO.id, GEO.id2, `GEO.display-label`, 
           `Median household income (dollars)`, 
           `Percent workers commuting by public transportation`,
           `Percent population unemployed`,
           `Percent no health insurance coverage`,
           `Percent income below poverty level`)
            
  return(df)
}

# read in census data for  years 2007 through 2017
census_data_2007 <- suppressMessages(clean_data_2007_2009(
  "../quality-of-life-data/census-data/2007/ACS_07_1YR_DP3.csv", 2007))
census_data_2008 <- suppressMessages(clean_data_2007_2009(
  "../quality-of-life-data/census-data/2008/ACS_08_1YR_DP3.csv", 2008))
census_data_2009 <- suppressMessages(clean_data_2007_2009(
  "../quality-of-life-data/census-data/2009/ACS_09_1YR_DP3.csv", 2009))
census_data_2010 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2010/ACS_10_1YR_DP03.csv", 2010))
census_data_2011 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2011/ACS_11_1YR_DP03.csv", 2011))
census_data_2012 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2012/ACS_12_1YR_DP03.csv", 2012))
census_data_2013 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2013/ACS_13_1YR_DP03.csv", 2013))
census_data_2014 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2014/ACS_14_1YR_DP03.csv", 2014))
census_data_2015 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2015/ACS_15_1YR_DP03.csv", 2015))
census_data_2016 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2016/ACS_16_1YR_DP03.csv", 2016))
census_data_2017 <- suppressMessages(clean_data_2010_2017(
  "../quality-of-life-data/census-data/2017/ACS_17_1YR_DP03.csv", 2017))

# join all years into one dataframe
census_qol_df <- suppressMessages(full_join(census_data_2007, census_data_2008) %>% 
  full_join(census_data_2009) %>% 
  full_join(census_data_2010) %>% 
  full_join(census_data_2011) %>% 
  full_join(census_data_2012) %>% 
  full_join(census_data_2013) %>% 
  full_join(census_data_2014) %>% 
  full_join(census_data_2015) %>% 
  full_join(census_data_2016) %>% 
  full_join(census_data_2017) )

  ## If we want to fix GEO.display-label column then need code similar to this:
  # %>% 
  # separate(col = `GEO.display-label`, into = c("City","State","Area_type"), 
  #         sep = c(","), remove = TRUE)


# census_qol_df

```

### Join All Quality of Life Dataframes
This joins all of the non-transit related data into one dataframe.  
```{r, messages=FALSE}

# join all quality of life dataframes
qol_df <- left_join(population_df, census_qol_df, 
  by = c("Year", "GEO.id", "GEO.id2", "GEO.display-label")) %>% 
  left_join(gdp_df, by = c("GEO.id2", "Year")) %>% 
  left_join(lat_long_df, by = c("GEO.id2", "GEO.display-label")) %>% 
  select(-c(GEO.id, GeoName))

# qol_df

```
## Transit Data

### Functions to Clean up FTA Dataframes
These are three functions used to wrangle the transit data from the FTA. `clean_modes()` takes in a dataframe with variables `Modes` and groups categories them into a new variable called `modes_clean`. `clean_fta_df()` is a function to clean FTA dataframces. `clean_funding_df()` is a function to clean the FTA's transit agency funding data. 
```{r, messages=FALSE}

#function to clean the modes of transit
clean_modes <- function(df) {
  rail_abbr <- c('HR', 'LR', 'SR', 'CR', 'IP', 'MG', 'YR', 'AR', 'CC')
  bus_abbr <- c('MB', 'TB', 'CB', 'RB', 'PB', 'JT')
  other_abbr <- c('VP', 'DR', 'DT', 'TR', 'FB', 'OT', 'OR')
  
  mutate(df, modes_clean = 
      case_when(
        Modes %in% rail_abbr ~ "Rail",
        Modes %in% bus_abbr ~ "Bus",
        Modes %in% other_abbr ~ "Other",
        TRUE ~ "OTHER"))  %>% 
      filter(modes_clean != "OTHER")
  
}

# function to read in and clean up FTA dataframes
clean_fta_df <- function(sheet_number, col_name) {
  
  df <- read_xlsx("../FTA-data/FTA-dataframes/TS2.1TimeSeriesOpExpSvcModeTOS_2.xlsx", 
                  sheet=sheet_number, range="A1:AR5659", col_names=TRUE) 
  
  df <- df %>% 
    filter(`Reporter Type` == "Full Reporter") %>%
     gather(key = "Year", 
          value = Name_of_Var, 
           -`Last Report Year`,
           -`NTD ID`, 
           -`Legacy NTD ID`, 
           -`Agency Name`, 
           -`Agency Status`, 
           -`Reporter Type`, 
           -City, 
           -State, 
           -`Census Year`,
           -`UZA Name`,
           -UZA,
           -`UZA Area SQ Miles`,
           -`UZA Population`,
           -`2017 Status`,
          -Mode,
          -Service, 
          -`Mode Status`)  %>% 
    mutate(Modes = Mode) %>% 
    clean_modes() %>% 
      select(-Mode) %>% 
    filter(Year >= 2007) %>% 
    filter(UZA !=0)

    df[,col_name] <- df[,'Name_of_Var']
    df[,'Name_of_Var'] <- NULL

    return(df)
}

# function to clean up FTA funding dataframes
clean_funding_df <- function(sheet_number, col_name) {
  df <- read_xlsx(
    "../FTA-data/FTA-dataframes/TS1.1TimeSeriesOpCapFundingSummary_4 (2).xlsx", 
                  sheet=sheet_number, range="A1:AO2943", col_names=TRUE)
  
  df <- df %>% 
    filter(`Reporter Type` == "Full Reporter") %>% 
      select(-`Reporter Type`) %>%
      gather(key = "Year",
           value = Name_of_Var,
           -`Last Report Year`,
           -`NTD ID`,
            -`Legacy NTD ID`,
            -`Agency Name`,
           -`Agency Status`,
           -City,
           -State,
           -`Census Year`,
           -`Primary UZA Name`,
           -UZA,
           -`UZA Area SQ Miles`,
           -`UZA Population`,
           -`2017 Status`)

    df[,col_name] <- df[,'Name_of_Var']
    df[,'Name_of_Var'] <- NULL

    return(df)
}

```

## Main Transit Variables
Creates dataframe for each FTA variable: UPT, VRM, VRH, DRM, PMT, expenses, fares,  and cleans them.
```{r, messages=FALSE}
expenses_fta_df <- clean_fta_df(3, "total_expenses") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(total_expenses = sum(total_expenses, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, total_expenses) %>% 
  unique()

fares_fta_df <- clean_fta_df(8, "total_fares") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(total_fares = sum(total_fares, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, total_fares) %>% 
  unique()

drm_fta_df <- clean_fta_df(9, "drm") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(drm = sum(drm, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, drm) %>% 
  unique()

vrm_fta_df <- clean_fta_df(11, "vrm") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(vrm = sum(vrm, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, vrm) %>% 
  unique()

vrh_fta_df <- clean_fta_df(12, "vrh") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(vrh = sum(vrh, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, vrh) %>% 
  unique()

upt_fta_df <- clean_fta_df(13, "upt") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(upt = sum(upt, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, upt) %>% 
  unique()

pmt_fta_df <- clean_fta_df(14, "pmt") %>% 
  group_by(UZA, Year, modes_clean) %>% 
  mutate(pmt = sum(pmt, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Year, modes_clean, pmt) %>% 
  unique()

```

### Join FTA Variable Dataframes
```{r, messages=FALSE}
#create file with master info
master_fta_df <- clean_fta_df(3, "total_expenses") %>% 
  select(UZA, `UZA Area SQ Miles`, `UZA Population`)

# join all FTA Variable dataframes
primary_variable_fta_df <- 
  inner_join(master_fta_df, expenses_fta_df, by= c("UZA")) %>% 
  inner_join(fares_fta_df,    by= c("UZA", "UZA Name", "Year", "modes_clean")) %>% 
  inner_join(drm_fta_df,      by= c("UZA", "UZA Name", "Year", "modes_clean")) %>% 
  inner_join(vrh_fta_df,      by= c("UZA", "UZA Name", "Year", "modes_clean")) %>% 
  inner_join(vrm_fta_df,      by= c("UZA", "UZA Name", "Year", "modes_clean")) %>% 
  inner_join(pmt_fta_df,      by= c("UZA", "UZA Name", "Year", "modes_clean")) %>%
  inner_join(upt_fta_df,      by= c("UZA", "UZA Name", "Year", "modes_clean")) %>% 
  unique()
```

### Read in Transit Stations Dataframe
Reads in the transit stations dataframe from the FTA and cleans it. Then joins the master to the transit stations. 
```{r, messages=FALSE}

# Read in Master FTA Dataframe to use 
# as joining key from transit agency to UZA

transit_stations_master_fta_df <- read_xlsx(
  "../FTA-data/FTA-dataframes/FTA_September_2018.xlsx",
  sheet=2, range="A1:Y2129", col_names=TRUE) %>% 
  filter(`Reporter Type` == "Full Reporter") %>%  
  select(UZA, `5 digit NTD ID`)

# read in transit stations dataframe
transit_stations_df <- read_xlsx(
  "../FTA-data/FTA-dataframes/Transit Stations_0.xlsx",
  sheet=1, range="A1:L1100", col_names=TRUE) %>%
  filter(`Reporter Type` == "Full Reporter") %>% 
  mutate(Modes = Mode) %>% 
  clean_modes() %>% 
  select(-Mode) %>% 
  select(`NTD ID`, modes_clean, `Total Stations`)
  
  
# Creates final transit stations df by IDing with UZA ids 
# and joining those ids onto the stations data via Agnecy ID
# NOTE: this potentially double counts transit stations 
# that are used by multiple transit networks

final_transit_stations_df <- left_join(transit_stations_master_fta_df, 
  transit_stations_df, by = c("5 digit NTD ID" = "NTD ID" )) %>% 
  group_by(UZA, modes_clean) %>% 
  mutate(Total_Stations_2017 = sum(`Total Stations`, na.rm = TRUE)) %>% 
  select(UZA, modes_clean, Total_Stations_2017) %>% 
  filter(!is.na(modes_clean)) %>% 
  unique() 


```

### Read in Transit Funding Data
Creates dataframe for each FTA funding variable: total funding, state funding, local funding, other funding, and cleans them.
```{r, messages=FALSE}

# read in Total Funding dataframe
Total_Funding_df <- clean_funding_df(3, "Total_Funding") %>% 
  group_by(UZA, Year) %>% 
  mutate(Total_Funding = sum(Total_Funding, na.rm = TRUE)) %>%  
  select(UZA, Year, Total_Funding) %>% 
  unique()

# read in Federal Funding dataframe
Federal_Funding_df <- clean_funding_df(4, "Federal_Funding") %>% 
  group_by(UZA, Year) %>% 
  mutate(Federal_Funding = sum(Federal_Funding, na.rm = TRUE)) %>%  
  select(UZA, Year, Federal_Funding) %>% 
  unique()

# read in State Funding dataframe
State_Funding_df <- clean_funding_df(5, "State_Funding") %>% 
  group_by(UZA, Year) %>% 
  mutate(State_Funding = sum(State_Funding, na.rm = TRUE)) %>%  
  select(UZA, Year, State_Funding) %>% 
  unique()

# read in Local Funding dataframe
Local_Funding_df <- clean_funding_df(6, "Local_Funding") %>% 
  group_by(UZA, Year) %>% 
  mutate(Local_Funding = sum(Local_Funding, na.rm = TRUE)) %>%  
  select(UZA, Year, Local_Funding) %>% 
  unique()

# read in Other Funding dataframe (aka Fares and other assorted revenue) 
Other_Funding_df <- clean_funding_df(7, "Other_Funding") %>% 
  group_by(UZA, Year) %>% 
  mutate(Other_Funding = sum(Other_Funding, na.rm = TRUE)) %>%  
  select(UZA, Year, Other_Funding) %>% 
  unique()
```

### Join FTA Funding Dataframes
Joins the four funding different dataframes. 
```{r, messages=FALSE}

# join all Funding dataframes
fta_funding_df <- full_join(Total_Funding_df, Federal_Funding_df, by = c("UZA", "Year")) %>% 
  full_join(State_Funding_df, by = c("UZA", "Year")) %>% 
  full_join(Local_Funding_df, by = c("UZA", "Year")) %>% 
  full_join(Other_Funding_df, by = c("UZA", "Year")) 


```

### Add Identifiers to FTA Dataframe Through Relationship File and Join FTA dataframes
Read in relationship file between urbanized areas in transit data and metropolitan statistical areas in census data. Also cleans the joined dataframe. 


``` {r, messages=FALSE}

fta_df <- left_join(primary_variable_fta_df, 
  final_transit_stations_df, by = c("UZA", "modes_clean"))%>%
  left_join(fta_funding_df, by=c("UZA", "Year")) %>% 
  unique()

# get census key dataframe
suppressMessages(
census_UZA_MSA_key <- read_csv("../census-FTA-joining-key/UZA_MSA_join.txt") %>% 
  mutate("GEO.id2" = CBSA) %>% 
  arrange(desc(UAPOP)) %>% 
  select(GEO.id2, UA, UANAME, UAPOP))

# join FTA dataframes here
final_fta_df <- left_join(census_UZA_MSA_key, fta_df,
                    by = c("UAPOP" = "UZA Population")) %>% 
  mutate(Year = as.numeric(Year))%>% 
  filter(Year > 2006, Year < 2018) %>% 
  filter(!is.na(`UZA Name`)) %>% 
  filter(UANAME != "Not in a 2010 urban area" ) %>% 
  filter(UAPOP>100000) %>% 
  select(-UANAME, -UZA)
  
  
```



## Join Quality of Life and Transit Data

```{r, messages=FALSE}

# join final quality of life and fta datasets 
# and filter out non-urban areas and metro areas below 1 million population 
final_df <- left_join(qol_df, final_fta_df, by=c("GEO.id2", "Year"))%>% 
  filter(UA != 99999) %>% 
  mutate(gdp = gdp*1000000) %>% 
  select(-CENTLON, -CENTLAT, -UAPOP) %>% 
  filter(PopEstimate>=1000000)
 
# figure out which columns we want and rename columns accordingly
# clarify variables names
colnames(final_df)[1:29] <- c("msa_id",
                             "msa_name",
                             "pop_estimate_msa",
                             "year",
                             "median_household_income_msa",
                             "percent_commuting_msa",
                             "percent_unemployed_msa",
                             "percent_no_insurance_msa",
                             "percent_below_poverty_level",
                             "gdp_msa",
                             "intptlat",
                             "intptlon",
                             "ua_census_id",
                             "ua_sq_miles_2010",
                             "ua_fta_name",
                             "transit_modes",
                             "total_transit_expenses",
                             "total_fares",
                             "directional_route_miles",
                             "vehicle_hours",
                             "vehicle_miles",
                             "passenger_miles",
                             "passenger_trips",
                             "total_stations_2017",
                             "total_funding",
                             "federal_funding",
                             "state_funding",
                             "local_funding",
                             "other_funding")

```

## Adding Per Capita Variables 
```{r, messages = FALSE}

#Per Capita Transit Variables
final_df <- final_df %>% 
  mutate(per_capita_gdp = gdp_msa / pop_estimate_msa, 
         pmt_per_vrm = passenger_miles / vehicle_miles,
         pmt_per_vrh = passenger_miles / vehicle_hours,
         upt_per_vrh = passenger_trips / vehicle_hours,
         per_capita_vrm = vehicle_miles / pop_estimate_msa,
         per_capita_vrh = vehicle_hours / pop_estimate_msa,
         per_capita_pmt = passenger_miles / pop_estimate_msa,
         per_capita_upt = passenger_trips / pop_estimate_msa,
         recovery_ratio = total_fares / total_transit_expenses,
         fares_per_upt = total_fares / passenger_trips,
         cost_per_hour = total_transit_expenses / vehicle_hours,
         cost_per_trip = total_transit_expenses / passenger_trips,
         cost_per_pmt = total_transit_expenses / passenger_miles)
  
```

#Removing Inf & NaN Values
```{r, messages=FALSE}



# #Removing NaN and Infinite values caused by mutations and replace them with NA
# final_df <- as.data.frame(lapply(final_df, function(x) {
#   replace(x, is.infinite(x) | is.nan(x), NA)
#   }))
# 
# # convert factorial columns back into characters
# final_df <- final_df %>% 
#   mutate(msa_name = as.character(msa_name),
#          ua_census_id = as.character(ua_census_id),
#          ua_fta_name = as.character(ua_fta_name),
#          transit_modes = as.character(transit_modes))
    
```
## Write DF 
```{r, messages = FALSE}

write.csv(final_df, "FINAL_DATA.csv", row.names=F)

saveRDS(final_df, file = "final_data.RDA")

#readRDS("../final-data/final_data.RDA")
```

#Modeling Function
This function takes in the variables needed and select the columns of said variables and then eliminates rows with incomplete data (aka)
```{r, messages=FALSE}

set.seed(2)

# function to make a regression tree model with response variable per_capita_gdp
gdp_model <- function(explanatory_variables_eq, input1, input2=NULL, input3=NULL, input4=NULL, input5=NULL) {
  
  select1 <- substitute(input1)
  select2 <- substitute(input2)
  select3 <- substitute(input3)
  select4 <- substitute(input4)
  select5 <- substitute(input5)
  
  if(is.null(input2)){
    cleaned_data <- final_df %>% 
    select(per_capita_gdp, select1)
  }else if(is.null(input3)){
    cleaned_data <- final_df %>% 
    select(per_capita_gdp, select1, select2)
  }else if(is.null(input4)){
    cleaned_data <- final_df %>% 
    select(per_capita_gdp, select1, select2, select3)
  }else if(is.null(input5)){
    cleaned_data <- final_df %>% 
    select(per_capita_gdp, select1, select2, select3, select4)
  }else{
    cleaned_data <- final_df %>% 
    select(per_capita_gdp, select1, select2, select3, select4, select5)}
  
  # only take rows with all data present
  final_cleaned_data <- cleaned_data[complete.cases(cleaned_data),]
  
  n <- nrow(final_cleaned_data)
  # select approx 80% of the row numbers between 1 and n
  train_id <- sample(1:n, size=round(n*0.8)) 

  # the data we'll train the model on
  train_data <- final_cleaned_data[train_id,]

  # the data we'll test the model on 
  test_data <- final_cleaned_data[-train_id,]
  
  # final_train_data <- train_data %>% drop_na("per_capita_gdp")
  
  regression_formula <- paste0("per_capita_gdp ~ ", explanatory_variables_eq)
  
  regression_tree <- rpart(regression_formula, data=train_data)
  predictions <- as.vector(predict(regression_tree, test_data)) # a vector of probabilities
  final_test_data <- test_data %>% mutate(prediction = predictions)
  final_test_data$truth <- final_test_data[,"per_capita_gdp"]
  results <- final_test_data %>%
    summarise("Explanatory Variables" = explanatory_variables_eq,
              #Percent_Rows = round(n/3416, 2),
              MSE = formatC( (1/n() * sum((truth - predictions)^2, na.rm = T)), format = "e", digits = 2),
              MAE  = round(1/n() * sum(abs(truth - predictions), na.rm = T), 0),
              R2   = round(cor(truth, predictions),3))
  
  return(results)
}


```

#Begin Modeling
Because our ggplots showed very weak relationships between we did some exploratory modeling to determine the best metrics to predict gdp.
```{r, messages=FALSE}

# use our function on different explanatory variables
a <- gdp_model("percent_commuting_msa", "percent_commuting_msa")
b <- gdp_model("total_transit_expenses", "total_transit_expenses")
c <- gdp_model("directional_route_miles", "directional_route_miles")
d <- gdp_model("vehicle_hours", "vehicle_hours")
e <- gdp_model("passenger_miles", "passenger_miles")
f <- gdp_model("passenger_trips", "passenger_trips")
g <- gdp_model("total_funding", "total_funding")
h <- gdp_model("pmt_per_vrm", "pmt_per_vrm")
i <- gdp_model("pmt_per_vrh", "pmt_per_vrh")
j <- gdp_model("upt_per_vrh", "upt_per_vrh")
k <- gdp_model("per_capita_vrm", "per_capita_vrm")
l <- gdp_model("per_capita_vrh", "per_capita_vrh")
m <- gdp_model("per_capita_pmt", "per_capita_pmt")
n <- gdp_model("per_capita_upt", "per_capita_upt")
o <- gdp_model("recovery_ratio", "recovery_ratio")
p <- gdp_model("fares_per_upt", "fares_per_upt")
q <- gdp_model("cost_per_hour", "cost_per_hour")
r <- gdp_model("cost_per_trip", "cost_per_trip")
s <- gdp_model("cost_per_pmt", "cost_per_pmt")

model_results <- rbind(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)

kable(arrange(model_results, desc(as.numeric(R2))), 
      caption = "Exploratory Models")
```

```{r, messages=FALSE}

# get model results 
# one explanatory variable
model1 <- gdp_model( input1 = "per_capita_vrm", explanatory_variables_eq = "per_capita_vrm")
model2 <- gdp_model("percent_commuting_msa", "percent_commuting_msa")
model3 <- gdp_model("per_capita_pmt","per_capita_pmt")
model4 <- gdp_model("per_capita_vrh", "per_capita_vrh")

# two explanatory variables
model4 <- gdp_model("per_capita_vrm + percent_commuting_msa", 
                    "per_capita_vrm", "percent_commuting_msa")
model5 <- gdp_model("per_capita_vrm + per_capita_pmt", 
                    "per_capita_vrm", "per_capita_pmt")
model6 <- gdp_model("per_capita_vrm + per_capita_vrh", 
                    "per_capita_vrm", "per_capita_vrh")
model7 <- gdp_model("percent_commuting_msa + per_capita_pmt",
                    "percent_commuting_msa", "per_capita_pmt")
model8 <- gdp_model("percent_commuting_msa + per_capita_vrh", 
                    "percent_commuting_msa", "per_capita_vrh")
model9 <- gdp_model("percent_commuting_msa + per_capita_vrh", 
                    "percent_commuting_msa", "per_capita_vrh")

# three explanatory variables
model10 <- gdp_model("per_capita_vrm + percent_commuting_msa + per_capita_pmt", 
                     "per_capita_vrm", "percent_commuting_msa", "per_capita_pmt")
model11 <- gdp_model("per_capita_vrm + per_capita_pmt + per_capita_vrh", 
                     "per_capita_vrm","per_capita_pmt", "per_capita_vrh")
model12 <- gdp_model("per_capita_vrm + percent_commuting_msa + per_capita_vrh",
                     "per_capita_vrm", "percent_commuting_msa", "per_capita_vrh")
model13 <- gdp_model("percent_commuting_msa + per_capita_pmt + per_capita_vrh",
                     "percent_commuting_msa","per_capita_pmt", "per_capita_vrh")

# all four explanatory variables
model14 <- gdp_model(
  "per_capita_vrm + percent_commuting_msa + per_capita_pmt + per_capita_vrh", 
  "per_capita_vrm", "percent_commuting_msa",
  "per_capita_pmt","per_capita_vrh")

#extras
model15 <- gdp_model(
  "per_capita_vrm + per_capita_vrh + per_capita_upt",
  "per_capita_vrm", "per_capita_vrh","per_capita_upt")

model16 <- gdp_model(
  "per_capita_vrm + per_capita_vrh + recovery_ratio", 
   "per_capita_vrm", "per_capita_vrh","recovery_ratio")

model17 <- gdp_model(
  "per_capita_vrm + percent_commuting_msa + per_capita_vrh + transit_modes", 
  "per_capita_vrm","percent_commuting_msa",
  "per_capita_vrh", "transit_modes")

model18 <- gdp_model(
  "percent_commuting_msa + per_capita_pmt + transit_modes", 
                     "percent_commuting_msa", 
                     "per_capita_pmt", "transit_modes")

model19 <- gdp_model(
  "per_capita_vrm + per_capita_vrh + transit_modes", 
  "per_capita_vrm", "per_capita_vrh", "transit_modes")

model20 <- gdp_model(
  "per_capita_vrm + per_capita_vrh + transit_modes + percent_below_poverty_level", 
  "per_capita_vrm","per_capita_vrh", 
  "transit_modes","percent_below_poverty_level")


final_model <- rbind(model1, model2, model3, model4, model5, 
                     model6, model7, model8, model9, model10, 
                     model11, model12, model13, model14, model15,
                     model16, model17, model18, model19, model20)

kable(arrange(final_model, desc(as.numeric(MAE))), caption="Final Models, Arranged by MAE")

```
## Results

## Diagnostics

## Conclusion

Conclusion: a summary of your findings and a discussion of their limitations. First, remind the reader of the question that you originally set out to answer, and summarize your findings. Second, discuss the limitations of your model, and what could be done to improve it. You might also want to do the same for your data. This is your last opportunity to clarify the scope of your findings before a journalist misinterprets them and makes wild extrapolations! Protect yourself by being clear about what is not implied by your research.


There are several limitations/sources of error to this current exploration of the relationship between transit variables and GDP per capita for U.S. cities.  For example, the overlap between the urbanized areas and the metropolitan/micropolitan statistical areas is not perfect.  MARTIN ELABORATE HERE.  

Additionally, the researchers did not calculate a transit score that could serve as single explanatory variable.  This transit score would have incorporated various transit-related variables and weighed them accordingly.  The researchers did not pursue this avenue for data analysis because they lacked the transit knowledge necessary to create such a score as they are not transit experts.  


HDI > GDP 

Furthermore, it would have been ideal if the researchers had had access to transit data regarding fares and expenses. 

There are multiple directions for future research available following this study.  Working with the data utilized for this study is made accessible through the creation of the gluskr package.  

One suggestion for future research would involve resolving the discrepancy between urbanized areas and metropolitan/micropolitan statistical areas.  Another suggestion includes finding human development index (HDI) data that can be joined to the final dataframe so as to explore the relationship between transit and HDI instead of transit and GDP per capita.  Finally, it would be valuable to create a transit score for data analysis purposes. 