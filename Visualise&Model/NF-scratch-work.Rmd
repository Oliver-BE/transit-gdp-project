---
title: "NF scratch work"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libary-ing

```{r, message=FALSE}
library(rpart)
library(partykit)
library(dplyr)
library(pROC)
library(readr)
library(ggplot2)
library(tidyverse)
```

## ggplots comparing gdp to passenger trips  
```{r}
gdp_passengertrips <- ggplot(nicole_df, aes(x = gdp_msa, y = passenger_trips)) + geom_point()
plot(gdp_passengertrips)

# Yielded clusters of data.  Going to split into under 1.0x10^12 GDP and above that. 

nicole_df_gdp_under <- nicole_df %>% 
  filter(gdp_msa < 1000000000000)

nicole_df_gdp_over <- nicole_df %>%
  filter(gdp_msa >= 1000000000000)

gdp_passengertrips_under <- ggplot(nicole_df_gdp_under, aes(x = gdp_msa, y = passenger_trips)) +
  geom_point() +
  geom_smooth(method = lm, se=FALSE)

plot(gdp_passengertrips_under)

gdp_passengertrips_over <- ggplot(nicole_df_gdp_over, aes(x = gdp_msa, y = passenger_trips)) + geom_point()
plot(gdp_passengertrips_over)

```
## Employment against trips 
```{r}

gdp_employment <- ggplot(nicole_df, aes(x = percent_unemployed_msa, y = gdp_msa)) + geom_point() + geom_smooth(method=lm)
plot(gdp_employment)

## Graph has some outliers, so going to split by above and below gdp_msa once again: 

nicole_df_gdp_under <- nicole_df %>% 
  filter(gdp_msa < 1000000000000)

gdp_employment_under <- ggplot(nicole_df_gdp_under, aes(x = percent_unemployed_msa, y = gdp_msa)) + geom_point() + geom_smooth(method=lm)
plot(gdp_employment_under)

nicole_df_gdp_over <- nicole_df %>%
  filter(gdp_msa >= 1000000000000)

gdp_employment_over <- ggplot(nicole_df_gdp_over, aes(x = percent_unemployed_msa, y = gdp_msa)) + geom_point() + geom_smooth(method=lm)
plot(gdp_employment_over)

```

## Seeing how well trips is predicted by gdp and median household income:
```{r}
gdp_mhhi_ytrips <- ggplot(nicole_df, aes(x = gdp_msa, y = passenger_trips, size = median_household_income_msa/10000)) + geom_point()  
  
gdp_mhhi_ytrips

multivariate_regression <- lm(formula = passenger_trips ~ gdp_msa + median_household_income_msa, data = nicole_df)
multivariate_regression

```
## Plotting poverty as y trips as x
```{r}
nicole_df <- read_csv("/home/class20/nfrontero20/STAT231-F18/Projects/Final Project/final-project/final-data/FINAL_DATA.csv")

ggplot(nicole_df, aes(x = passenger_trips, y = percent_below_poverty_level)) + geom_point() + facet_grid(~transit_modes)

## Log 10 scale

trips.x_poverty.y <- nicole_df %>% 
  mutate(log10_trips = log10(passenger_trips)) %>%
  mutate(log10_poverty = log10(as.numeric(percent_below_poverty_level))) %>%
  ggplot(aes(x = log10_trips, y = log10_poverty)) + geom_jitter(alpha = .1) + facet_grid(.~transit_modes) + geom_smooth(method = 'lm') 
plot(trips.x_poverty.y)

```
## Plotting trips y against percent employed x 
```{r}
## Without the faceting by transit modes

trips.x_unemployment.y <- nicole_df %>% 
  mutate(log10_trips = log10(passenger_trips)) %>%
  ggplot(aes(x = log10_trips, y = percent_unemployed_msa)) + geom_jitter(alpha = .1) + geom_smooth(method = 'lm') 
plot(trips.x_unemployment.y)


## With the faceting by transit modes

trips.x_unemployment.y_transitmode.facet <- nicole_df %>% 
  mutate(log10_trips = log10(passenger_trips)) %>%
  ggplot(aes(x = log10_trips, y = percent_unemployed_msa)) + geom_jitter(alpha = .1) + facet_grid(.~transit_modes) + geom_smooth(method = 'lm') 
plot(trips.x_unemployment.y_transitmode.facet)




```


## Regression tree model example
```{r}
set.seed(123)
n <- nrow(final_df)
final_df <- final_df[complete.cases(final_df),]
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train <- final_df[train_id,] # the data set we'll train the model on
test <- final_df[-train_id,]

tree <- rpart(gdp_msa ~ passenger_trips + vehicle_miles + vehicle_hours + total_stations_2017 + total_funding + federal_funding + state_funding + local_funding + other_funding, data=final_df)
tree

#### questions here
pred <- as.vector(predict(tree, test)) # a vector of probabilities
test <- test %>% mutate(prediction = pred)

results <- test %>%
  summarise(MSE = 1/n() * sum((gdp_msa - pred)^2, na.rm = T),
            MAE  = 1/n() * sum(abs(gdp_msa - pred), na.rm = T),
            R2   = cor(gdp_msa, pred))
results

```
## In general, x is transit, y is a quality of life metric. 

## x = passenger_trips, vehicle_miles, total_funding
## y = 

## Run this each time:
```{r}

nicole_df <- read_csv("../final-data/FINAL_DATA.csv")

set.seed(123)
nicole_df_master <- nicole_df[complete.cases(nicole_df),]
n <- nrow(nicole_df_master)
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train <- nicole_df_master[train_id,] # the data set we'll train the model on
test <- nicole_df_master[-train_id,]

```


## This is our example of our function WORKS
```{r}

tree_diagram <- function(outcome_variable) {
  train1 <- train %>% drop_na(outcome_variable)
  formula <- paste0(outcome_variable, " ~ passenger_trips + vehicle_miles + total_funding")
  tree <- rpart(formula, data=train1)
  
  pred <- as.vector(predict(tree, test)) # a vector of probabilities
  test <- test %>% mutate(prediction = pred)
  
  test$truth <- test[,outcome_variable]
  results <- test %>%
    summarise("Response Variable" = outcome_variable,
              MSE = 1/n() * sum((truth - pred)^2, na.rm = T),
              MAE  = 1/n() * sum(abs(truth - pred), na.rm = T),
              R2   = cor(truth, pred))
          
  
  return(results)
}

gdp_msa_tree <- tree_diagram("gdp_msa")
med_household_tree <- tree_diagram("median_household_income_msa")
unemployed_tree <- tree_diagram("percent_unemployed_msa")
commuting_tree <- tree_diagram("percent_workers_commuting_by_public_transit_msa")
poverty_tree <- tree_diagram("percent_below_poverty_level")
 
```


## rbind
```{r}
rbind(gdp_msa_tree, med_household_tree, unemployed_tree, commuting_tree, poverty_tree)
```


