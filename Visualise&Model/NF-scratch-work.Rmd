---
title: "NF scratch work"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libary-ing

```{r, message=FALSE}
library(rpart)
library(partykit)
library(dplyr)
library(pROC)
library(readr)
library(ggplot2)
library(tidyverse)
library(tidyr)
options(scipen = 0)
```

## Importing data set 
```{r}
nicole_df <- readRDS("../final-data/final_data.RDA")
```

## exploring the relationships between the final explanatory variables (per_capita_vrm + percent_commuting_msa + per_capita_pmt + per_capita_vrh):

```{r}

# x = per_capita_vrm
# y = percent_commuting_msa
# R2 is very very small
model_a <- lm(formula = percent_commuting_msa ~ per_capita_vrm, data = nicole_df)

ggplot(nicole_df, aes(x = per_capita_vrm, y = percent_commuting_msa )) + geom_point() + geom_smooth(method = 'lm', se = F)

summary(model_a)

# x = per_capita_vrm
# y = per_capita_pmt
# R2 = .746
model_b <- lm(formula = per_capita_pmt ~ per_capita_vrm, data = nicole_df)

ggplot(nicole_df, aes(x = per_capita_vrm, y = per_capita_pmt)) + geom_point() + geom_smooth(method = 'lm', se = F)

summary(model_b)

# x = per_capita_vrm
# y = per_capita_vrh
# R2 = .865
model_c <- lm(formula = per_capita_vrh ~ per_capita_vrm, data = nicole_df)

ggplot(nicole_df, aes(x = per_capita_vrm, y = per_capita_vrh)) + geom_point() + geom_smooth(method = 'lm', se = F)

summary(model_c)

# x = percent_commuting_msa
# y = per_capita_pmt
# R2 = very poor
model_d <- lm(formula = per_capita_pmt ~ percent_commuting_msa, data = nicole_df)

ggplot(nicole_df, aes(x = percent_commuting_msa, y = per_capita_pmt)) + geom_point() + geom_smooth(method = 'lm', se = F)

summary(model_d)

# x = percent_commuting_msa
# y = per_capita_vrh
# R2 = very bad
model_e <- lm(formula = per_capita_vrh ~ percent_commuting_msa, data = nicole_df)

ggplot(nicole_df, aes(x = percent_commuting_msa, y = per_capita_vrh)) + geom_point() + geom_smooth(method = 'lm', se = F)

summary(model_e)

# x = per_capita_pmt
# y = per_capita_vrh
# y = .488
model_f <- lm(formula = per_capita_vrh ~ per_capita_pmt, data = nicole_df)

ggplot(nicole_df, aes(x = per_capita_pmt, y = per_capita_vrh)) + geom_point() + geom_smooth(method = 'lm', se = F)

summary(model_f)
```


## ggplots comparing y = per_capita_gdp to transit variables

```{r}

# x = pmt_per_vrm; y = per_capita_gdp
model_pmt_per_vrm <- lm(formula = per_capita_gdp ~ pmt_per_vrm, data = nicole_df)
ggplot(nicole_df, aes(x = pmt_per_vrm, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_pmt_per_vrm)
# .00477

# x = pmt_per_vrh; y = per_capita_gdp
model_pmt_per_vrh <- lm(formula = per_capita_gdp ~ pmt_per_vrh, data = nicole_df)
ggplot(nicole_df, aes(x = pmt_per_vrh, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_pmt_per_vrh)
# .0027 

# upt_per_vrh
model_upt_per_vrh <- lm(formula = per_capita_gdp ~ upt_per_vrh, data = nicole_df)
ggplot(nicole_df, aes(x = upt_per_vrh, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_upt_per_vrh)
# .00192

# x = per_capita_vrm; y = per_capita_gdp
model_per_capita_vrm <- lm(formula = per_capita_gdp ~ per_capita_vrm, data = nicole_df)
ggplot(nicole_df, aes(x = per_capita_vrm, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_per_capita_vrm)
# .0007561

# x = per_capita_vrh; y = per_capita_gdp
model_per_capita_vrh <- lm(formula = per_capita_gdp ~ per_capita_vrh, data = nicole_df)
ggplot(nicole_df, aes(x = per_capita_vrh, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_per_capita_vrh)
# .001225

# x = per_capita_pmt
model_per_capita_pmt <- lm(formula = per_capita_gdp ~ per_capita_pmt, data = nicole_df)
ggplot(nicole_df, aes(x = per_capita_pmt, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_per_capita_pmt )
# .0070

# x = per_capita_upt
model_per_capita_upt <- lm(formula = per_capita_gdp ~ per_capita_upt, data = nicole_df)
ggplot(nicole_df, aes(x = per_capita_upt, y = per_capita_gdp)) + geom_point()
summary(model_per_capita_upt)
# .005

# recovery_ratio
model_recovery_ratio <- lm(formula = per_capita_gdp ~ recovery_ratio, data = nicole_df)
ggplot(nicole_df, aes(x = recovery_ratio, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_recovery_ratio)
# .0036

# fares_per_upt
model_fares_per_upt <- lm(formula = per_capita_gdp ~ fares_per_upt, data = nicole_df)
ggplot(nicole_df, aes(x = fares_per_upt, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_fares_per_upt)
# .001

# cost_per_hour
model_cost_per_hour <- lm(formula = per_capita_gdp ~ cost_per_hour, data = nicole_df)
ggplot(nicole_df, aes(x = cost_per_hour, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_cost_per_hour)
#.00345 

# cost_per_pmt
model_cost_per_hour <- lm(formula = per_capita_gdp ~ cost_per_hour, data = nicole_df)
ggplot(nicole_df, aes(x = cost_per_hour, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_cost_per_hour)
# .0035

# percent_commuting_msa
model_percent_commuting_msa <- lm(formula = per_capita_gdp ~ percent_commuting_msa, data = nicole_df)
ggplot(nicole_df, aes(x = percent_commuting_msa, y = per_capita_gdp)) + geom_point() + geom_smooth(method = 'lm', se = F)
summary(model_percent_commuting_msa)
# .09
```

## ggplots comparing gdp to passenger trips  
```{r}
gdp_passengertrips <- ggplot(nicole_df, aes(x = gdp_msa, y = passenger_trips)) + geom_point()
plot(gdp_passengertrips)

# Yielded clusters of data.  Going to split into under 1.0x10^12 GDP and above that. 

nicole_df_gdp_under <- nicole_df %>% 
  filter(gdp_msa < 1000000000000)

nicole_df_gdp_over <- nicole_df %>%
  filter(gdp_msa >= 1000000000000)

gdp_passengertrips_under <- ggplot(nicole_df_gdp_under, aes(x = gdp_msa, y = passenger_trips)) +
  geom_point() +
  geom_smooth(method = lm, se=FALSE)

plot(gdp_passengertrips_under)

gdp_passengertrips_over <- ggplot(nicole_df_gdp_over, aes(x = gdp_msa, y = passenger_trips)) + geom_point()
plot(gdp_passengertrips_over)

```

## ggplots comparing y = per_capita_gdp, x = upt_per_vrh, recovery_ratio, fares_per_upt, cost_per_hour, cost_per_trip, cost_per_pmt
```{r}
nicole_df <- readRDS("../final-data/final_data.RDA") 

nicole_df <- as.data.frame(lapply(nicole_df, function(x) {
  replace(x, is.infinite(x) | is.nan(x), NA)}))


```


## ggplots comparing y = per_capita_gdp, x = upt_per_vrh, recovery_ratio, fares_per_upt, cost_per_hour, cost_per_trip, cost_per_pmt

```{r}

ggplot_function <- function(expl_variable){
  formula <- paste0(expl_variable)
  ggplot <- ggplot(nicole_df, aes(x = formula, y = per_capita_gdp)) + 
    geom_point() + 
    geom_smooth(method = 'lm', se = F)
 

  return(ggplot)

}
ggplot_function("upt_per_vrh")
ggplot_function("recovery_ratio")
ggplot_function("fares_per_upt")
ggplot_function("cost_per_hour")
ggplot_function("cost_per_trip")
ggplot_function("cost_per_pmt")
  

summary_function <- function(expl_variable){
  formula <- paste0("per_capita_gdp ~ ", expl_variable)

  model_name <- lm(formula = formula, data = nicole_df)
  summary <- summary(model_name)

  return(summary)
}
summary_function("pop_estimate_msa")

```




## Employment against trips 
```{r}

gdp_employment <- ggplot(nicole_df, aes(x = percent_unemployed_msa, y = gdp_msa)) + geom_point() + geom_smooth(method=lm)
plot(gdp_employment)

## Graph has some outliers, so going to split by above and below gdp_msa once again: 

nicole_df_gdp_under <- nicole_df %>% 
  filter(gdp_msa < 1000000000000)

gdp_employment_under <- ggplot(nicole_df_gdp_under, aes(x = percent_unemployed_msa, y = gdp_msa)) + geom_point() + geom_smooth(method=lm)
plot(gdp_employment_under)

nicole_df_gdp_over <- nicole_df %>%
  filter(gdp_msa >= 1000000000000)

gdp_employment_over <- ggplot(nicole_df_gdp_over, aes(x = percent_unemployed_msa, y = gdp_msa)) + geom_point() + geom_smooth(method=lm)
plot(gdp_employment_over)

```

## Seeing how well trips is predicted by gdp and median household income:
```{r}
gdp_mhhi_ytrips <- ggplot(nicole_df, aes(x = gdp_msa, y = passenger_trips, size = median_household_income_msa/10000)) + geom_point()  
  
gdp_mhhi_ytrips

multivariate_regression <- lm(formula = passenger_trips ~ gdp_msa + median_household_income_msa, data = nicole_df)
multivariate_regression

```
## Plotting poverty as y trips as x
```{r}
nicole_df <- read_csv("/home/class20/nfrontero20/STAT231-F18/Projects/Final Project/final-project/final-data/FINAL_DATA.csv")

ggplot(nicole_df, aes(x = passenger_trips, y = percent_below_poverty_level)) + geom_point() + facet_grid(~transit_modes)

## Log 10 scale

trips.x_poverty.y <- nicole_df %>% 
  mutate(log10_trips = log10(passenger_trips)) %>%
  mutate(log10_poverty = log10(as.numeric(percent_below_poverty_level))) %>%
  ggplot(aes(x = log10_trips, y = log10_poverty)) + geom_jitter(alpha = .1) + facet_grid(.~transit_modes) + geom_smooth(method = 'lm') 
plot(trips.x_poverty.y)

```
## Plotting trips y against percent employed x 
```{r}
## Without the faceting by transit modes

trips.x_unemployment.y <- nicole_df %>% 
  mutate(log10_trips = log10(passenger_trips)) %>%
  ggplot(aes(x = log10_trips, y = percent_unemployed_msa)) + geom_jitter(alpha = .1) + geom_smooth(method = 'lm') 
plot(trips.x_unemployment.y)


## With the faceting by transit modes

trips.x_unemployment.y_transitmode.facet <- nicole_df %>% 
  mutate(log10_trips = log10(passenger_trips)) %>%
  ggplot(aes(x = log10_trips, y = percent_unemployed_msa)) + geom_jitter(alpha = .1) + facet_grid(.~transit_modes) + geom_smooth(method = 'lm') 
plot(trips.x_unemployment.y_transitmode.facet)




```

## ggplot of GDP=x, population=y
```{r}

pop_gdp_model <- lm(formula = pop_estimate_msa ~ gdp_msa, data = nicole_df)

ggplot(pop_gdp_model, aes(x = gdp_msa, y = pop_estimate_msa)) + geom_smooth(method = 'lm') + geom_point()
# Generates a graph with a pretty strong correlation. 

summary(pop_gdp_model)
```

## Population and GDP
```{r}

# filtering
pop_under <- nicole_df %>% 
  filter(pop_estimate_msa < 10000000 & pop_estimate_msa <= 5000000)

pop_over <- nicole_df %>% 
  filter(pop_estimate_msa < 10000000 & pop_estimate_msa > 5000000)

# ggplotting

ggplot(pop_under, aes(x = gdp_msa, y = pop_estimate_msa)) + geom_smooth(method = 'lm') + geom_point()

ggplot(pop_over, aes(x = gdp_msa, y = pop_estimate_msa)) + geom_smooth(method = 'lm') + geom_point()

# model
pop_gdp_under_model <- lm(formula = pop_estimate_msa ~ gdp_msa, data = pop_under)

summary(pop_gdp_under_model)

pop_gdp_over_model <- lm(formula = pop_estimate_msa ~ gdp_msa, data = pop_over)

summary(pop_gdp_over_model)

```

## Per capita = x, passenger trips = y
```{r}

capita_trips_model <- lm(formula = passenger_trips ~ per_capita_gdp, data = nicole_df)
ggplot(nicole_df, aes(x = per_capita_gdp, y = passenger_trips)) + geom_point()
summary(capita_trips_model)
```


## Regression tree model example
```{r}
set.seed(123)
n <- nrow(final_df)
final_df <- final_df[complete.cases(final_df),]
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train <- final_df[train_id,] # the data set we'll train the model on
test <- final_df[-train_id,]

tree <- rpart(gdp_msa ~ passenger_trips + vehicle_miles + vehicle_hours + total_stations_2017 + total_funding + federal_funding + state_funding + local_funding + other_funding, data=final_df)
tree

#### questions here
pred <- as.vector(predict(tree, test)) # a vector of probabilities
test <- test %>% mutate(prediction = pred)

results <- test %>%
  summarise(MSE = 1/n() * sum((gdp_msa - pred)^2, na.rm = T),
            MAE  = 1/n() * sum(abs(gdp_msa - pred), na.rm = T),
            R2   = cor(gdp_msa, pred))
results

```
## In general, x is transit, y is a quality of life metric. 

## x = passenger_trips, vehicle_miles, total_funding
## y = 

## Run this each time:
```{r}

#nicole_df <- read_csv("../final-data/FINAL_DATA.csv")

nicole_df <- readRDS("../final-data/final_data.RDA") %>% 
  mutate(avg_speed = vehicle_miles / vehicle_hours)

set.seed(123)
nicole_df_master <- nicole_df[complete.cases(nicole_df),]
n <- nrow(nicole_df_master)
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train <- nicole_df_master[train_id,] # the data set we'll train the model on
test <- nicole_df_master[-train_id,]

```


## This is our example of our function WORKS
```{r}

tree_diagram <- function(outcome_variable) {
  train1 <- train %>% drop_na(outcome_variable)
  formula <- paste0(outcome_variable, " ~ passenger_trips + vehicle_miles + total_funding")
  tree <- rpart(formula, data=train1)
  
  pred <- as.vector(predict(tree, test)) # a vector of probabilities
  test <- test %>% mutate(prediction = pred)
  
  test$truth <- test[,outcome_variable]
  results <- test %>%
    summarise("Response Variable" = outcome_variable,
              MSE = 1/n() * sum((truth - pred)^2, na.rm = T),
              MAE  = 1/n() * sum(abs(truth - pred), na.rm = T),
              R2   = cor(truth, pred))
          
  
  return(results)
}

gdp_msa_tree <- tree_diagram("gdp_msa")
med_household_tree <- tree_diagram("median_household_income_msa")
unemployed_tree <- tree_diagram("percent_unemployed_msa")
commuting_tree <- tree_diagram("percent_workers_commuting_by_public_transit_msa")
poverty_tree <- tree_diagram("percent_below_poverty_level")
hours_tree <- tree_diagram("vehicle_hours")

 
```

## rbind
```{r}
table <- rbind(gdp_msa_tree, med_household_tree, unemployed_tree, commuting_tree, poverty_tree, hours_tree)

# source: https://stackoverflow.com/questions/29875914/rounding-values-in-a-dataframe-in-rs
round_df <- function(x, digits) {
    # round all numeric variables
    # x: data frame 
    # digits: number of digits to round
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    return(x)
}

testdf <- round_df(table, 2)

asdf <- table %>%
  mutate(MSE = signif(MSE, digits = 3),
         MAE = signif(MAE, digits = 3),
         R2 = signif(R2, digits = 3)) %>% 
  select(`Response Variable`, MSE, MAE, R2)


asdf
```

## NEW MODEL
```{r}

NEW_tree_diagram <- function(explanatory_variables) {
  train1 <- train %>% drop_na("gdp_msa")
  formula <- paste0("gdp_msa ~ ", explanatory_variables)
  tree <- rpart(formula, data=train1)
  
  pred <- as.vector(predict(tree, test)) # a vector of probabilities
  test <- test %>% mutate(prediction = pred)
  
  test$truth <- test[,"gdp_msa"]
  results <- test %>%
    summarise("Explanatory Variables" = explanatory_variables,
              MSE = 1/n() * sum((truth - pred)^2, na.rm = T),
              MAE  = 1/n() * sum(abs(truth - pred), na.rm = T),
              R2   = cor(truth, pred))
          
  
  return(results)
}

# percent_workers_commuting_by_public_transit_msa
# passenger_trips
# pop_estimate_msa

pass_trips <- NEW_tree_diagram("passenger_trips")
workers <- NEW_tree_diagram("percent_workers_commuting_by_public_transit_msa")
pop <- NEW_tree_diagram("pop_estimate_msa")

pass_trips_workers <- NEW_tree_diagram("percent_workers_commuting_by_public_transit_msa + passenger_trips")
pass_trips_pop <- NEW_tree_diagram("passenger_trips + pop_estimate_msa")
workers_pop <- NEW_tree_diagram("percent_workers_commuting_by_public_transit_msa + pop_estimate_msa")

pass_trips_workers_pop <- NEW_tree_diagram("percent_workers_commuting_by_public_transit_msa + passenger_trips + pop_estimate_msa")

NEW_table <- rbind(pass_trips, workers, pop, pass_trips_workers, 
                   pass_trips_pop, workers_pop, pass_trips_workers_pop)

View(NEW_table)

```



