---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---
 

```{r}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(jsonlite)
library(httr)
library(rvest)
library(readxl)
library(tidyverse)
library(mdsr)   
library(tidyr)
library(ggplot2)
library(readr)
library(knitr)




#Total Trips Over Time
final_df %>% 
  group_by(year, transit_modes) %>% 
  summarise(sum_trips = sum(passenger_trips)) %>% 
  ggplot( aes(x = year, y = sum_trips/1000000000, color = transit_modes)) +geom_point() + labs(x= "Year", y= "Total Trips (in Billions)")
```

```{r}
#gdp and percent workers commuting
gdp_commuting_model_df <- final_df %>% 
  mutate(percent_workers_commuting_by_public_transit_msa = ifelse(percent_workers_commuting_by_public_transit_msa==0, NA, percent_workers_commuting_by_public_transit_msa))%>%
  mutate(gdp_msa = ifelse(gdp_msa==0, NA, gdp_msa)) %>%
  filter(transit_modes == "Non-Rail Bus") %>% 
  mutate(log10_gdp= log10(gdp_msa))  %>% 
  mutate(log10_commuting = log10(percent_workers_commuting_by_public_transit_msa))

gdp_commuting_model <- lm(formula = log10_commuting~ log10_gdp, data = gdp_commuting_model_df)

  ggplot(gdp_commuting_model_df, aes(x =log10_gdp, y = log10_commuting)) +geom_jitter(alpha= .2) + labs(x= "GDP by City (Scaled by log 10)", y = " % Workers Commuting via Public Transit (Scaled log 10)" , title = "Relationship between GDP and Commuting by Public Transit") + geom_smooth(method = 'lm') 
```
  
```{r}
#Commuting & Passenger Trips Model 
commuting_trips_model_df <- final_df %>% 
  mutate(passenger_trips = ifelse(passenger_trips==0, NA, passenger_trips)) %>% 
  mutate(percent_workers_commuting_by_public_transit_msa = ifelse(percent_workers_commuting_by_public_transit_msa==0, NA, percent_workers_commuting_by_public_transit_msa))%>%
  mutate(log10_trips= log10(passenger_trips))  %>% 
  mutate(log10_commuting = log10(percent_workers_commuting_by_public_transit_msa)) %>% 
  group_by(transit_modes)

commuting_trips_model <-lm(formula = log10_commuting~ log10_trips, data = commuting_trips_model_df)

#Just Rail data points
rail_only <-  commuting_trips_model_df %>% 
  filter(transit_modes== "Rail")

rail_only_model <-lm(formula = log10_commuting~ log10_trips, data = rail_only)

#Bus
bus_model_df <- commuting_trips_model_df %>% 
  filter(transit_modes == "Non-Rail Bus")

bus_model <-lm(formula = log10_commuting~ log10_trips, data = bus_model_df)

#Other
other_model_df <- commuting_trips_model_df %>% 
  filter(transit_modes == "Non-Rail Other")

other_model <-lm(formula = log10_commuting~ log10_trips, data = other_model_df)

commuting_trips_model <-lm(formula = log10_commuting~ log10_trips, data = commuting_trips_model_df)

ggplot(commuting_trips_model_df, aes(x = log10_commuting, y = log10_trips)) + geom_jitter(alpha= .2)+ labs(x= "Percent Workers Commuting by Public Transit (scaled  log10)", y = "Passenger Trips (scaled to log10)", title="Relationship between Percent of Workers Commuting and Trips") + geom_smooth(method = 'lm', formula = y~x, se = FALSE) + facet_grid(.~transit_modes) 
```

$Rail: r^2 = 0.1377$
$Bus: r^2 = 0.08995$
$Other: r^2 = 0.06483$

```{r}
#Trips & GDP model
trips_gdp_model_df <-final_df %>% 
  mutate(passenger_trips = ifelse(passenger_trips==0, NA, passenger_trips)) %>% 
  mutate(gdp_msa = ifelse(gdp_msa==0, NA, gdp_msa)) %>% 
  mutate(log10_trips= log10(passenger_trips))  %>% 
  mutate(log10_gdp = log10(gdp_msa)) 

trips_gdp_model <-lm(formula = log10_gdp ~ log10_trips, data = trips_gdp_model_df)

ggplot(trips_gdp_model_df, aes(y = log10_trips, x = log10_gdp)) + geom_jitter(alpha= .2)+ labs(x= "Passenger Trips (scaled to log10)", y = "City GDP (scaled to log10)", title = "Trips and GDP ") + geom_smooth(method = 'lm', formula = y~x) 

```

1. Condition 1: $r^2 = 0.09727$
1. Condition 1: $log10(gdp) = 9.489803 + log10(trips)$

```{r} 

#Funding and Trips ggplot
funding_trips_model_df <- final_df %>% 
  mutate(passenger_trips = ifelse(passenger_trips==0, NA, passenger_trips)) %>% 
  mutate(total_funding = ifelse(total_funding==0, NA, total_funding)) %>% 
  mutate(log10_trips= log10(passenger_trips))  %>% 
  mutate(log10_funding = log10(total_funding)) %>% 
  filter(transit_modes == "Non-Rail Bus")  

funding_trips_model <- lm(formula = log10_funding ~ log10_trips, data = funding_trips_model_df)

ggplot(funding_trips_model_df,aes(x = log10_trips, y = log10_funding)) + geom_jitter(alpha= .2)+ labs(x= "log10(Passenger Trips)", y = "log10(Total Funding)") + geom_smooth(method = 'lm', formula = y~x) 

summary(funding_trips_model)

```


```{r}
#Average Speed 
avg_speed_model_df <- final_df %>% 
  mutate(avg_speed = vehicle_miles/vehicle_hours) %>% 
  mutate(passenger_trips = ifelse(passenger_trips==0, NA, passenger_trips)) %>% 
  mutate(avg_speed = ifelse(avg_speed==0, NA, avg_speed))%>% 
  mutate(log10_trips= log10(passenger_trips))  %>% 
  mutate(log10_speed = log10(avg_speed))

#Rail
rail_only <-  avg_speed_model_df %>% 
  filter(transit_modes== "Rail")

rail_only_model <-lm(formula = log10_trips~ avg_speed, data = rail_only)

#Bus
bus_model_df <- avg_speed_model_df %>% 
  filter(transit_modes == "Non-Rail Bus")

bus_model <-lm(formula = log10_trips~ avg_speed, data = bus_model_df)

#Other
other_model_df <- avg_speed_model_df %>% 
  filter(transit_modes == "Non-Rail Other")

other_model <-lm(formula = log10_trips~ avg_speed, data = other_model_df)


ggplot(avg_speed_model_df,aes(x =avg_speed, y = log10_trips)) + geom_jitter(alpha= .2)+ labs(x= "Average Speed ", y = "Passenger Trips (Scaled log 10)", title = "Relationship between Average Speed and Trips") + geom_smooth(method = 'lm', formula = y~x) + facet_grid(~transit_modes)


```


```{r}
#Average Speed vs. gdp
gdp_speed_model_df <- final_df %>% 
  mutate(avg_speed = vehicle_miles/vehicle_hours) %>% 
  mutate(passenger_trips = ifelse(passenger_trips==0, NA, passenger_trips)) %>% 
  mutate(gdp_msa = ifelse(avg_speed==0, NA, gdp_msa))%>% 
  mutate(log10_gdp_per_cap= log10(gdp_msa/pop_estimate_msa))  %>% 
  mutate(log10_speed = log10(avg_speed))



ggplot(gdp_speed_model_df,aes(x =log10_speed, y = log10_gdp_per_cap)) + geom_jitter(alpha= .2)+ labs(x= "Average Speed", y = "GDP") + geom_smooth(method = 'lm', formula = y~x)+ facet_grid(~transit_modes)
```

```{r}
martin_df <- readRDS("final-data/final_data.RDA") %>% 
  mutate(avg_speed = vehicle_miles / vehicle_hours) %>% 

set.seed(123)
martin_df_master <- martin_df[complete.cases(martin_df),]
n <- nrow(martin_df_master)
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train <- martin_df_master[train_id,] # the data set we'll train the model on
test <- martin_df_master[-train_id,]
```

