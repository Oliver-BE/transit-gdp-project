---
title: "FTA-data"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(jsonlite)
library(httr)
library(rvest)
library(readxl)
library(tidyverse)
library(mdsr)   
library(tidyr)
library(ggplot2)
library(readr)
library(knitr)
```

## FTA data

```{r, message=FALSE}

#Master is a bit weird
#It contains master info about each transportation agency and the relevant Urbanized Area (UZA)
#It has  a different spreadsheet design so I don't use the function for it

master_df <- read_xlsx("FTA_September_2018.xlsx", sheet=2, range="A1:Y2129", col_names=TRUE) %>% 
  filter(`Reporter Type` == "Full Reporter") %>% 
  filter(Active == "Active")


FTA_df <- function(sheet_number, col_name) {
  df <- read_xlsx("FTA_September_2018.xlsx", sheet=sheet_number, range="A1:HB2129", col_names=TRUE) 
  
df <- df %>% 
  filter(`Reporter Type` == "Full Reporter") %>% 
  filter(Active == "Active") %>% 
    gather(key = "Date", 
         value = Name_of_Var, 
         -`5 digit NTD ID`, 
         -`4 digit NTD ID`, 
         -Agency, 
         -Active, 
         -`Reporter Type`, 
         -UZA, 
         -`UZA Name`, 
         -Modes, 
         -TOS) %>%
    mutate_(col_name = 'Name_of_Var') %>%
    select(-Name_of_Var)
  
  return(df)
}

 
#Unlinked Passenger Trip (UPTs)
UPT_df<- FTA_df(3, "UPTs")%>% 
  mutate(UPTs = as.numeric(UPTs)) %>% #convert UPT from characters into doubles
  group_by(UZA, Date) %>% 
  #Group by Urbanized Area (UZA) as to collapse areas with multiple agencies and to collapse different kinds of transportation. Group by Date so as to not collapse the time series
  mutate(UPTs = sum(UPTs, na.rm = TRUE)) %>% 
  select(UZA, `UZA Name`, Date, UPTs) %>% 
  unique() %>% 
  mutate(Year = substr(Date, 4, 5))

#Vehicle Revenue Miles (VRMs)
VRM_df<- FTA_df(4, "VRMs") %>% 
  gather(key = "Date", 
         value = VRMs, 
         -`5 digit NTD ID`, 
         -`4 digit NTD ID`, 
         -Agency, 
         -Active, 
         -`Reporter Type`, 
         -UZA, 
         -`UZA Name`, 
         -Modes, 
         -TOS)

#Vehicle Revenue Hours (VRHs)
VRH_df<- FTA_df(5, "VRHs") %>% 
  gather(key = "Date", 
         value = VRHs, 
         -`5 digit NTD ID`, 
         -`4 digit NTD ID`, 
         -Agency, 
         -Active, 
         -`Reporter Type`, 
         -UZA, 
         -`UZA Name`, 
         -Modes, 
         -TOS)


#Vehicles Operated in Maximum Service (VOMS) aka Peak Service
VOMS_df <-FTA_df("FTA_September_2018.xlsx", 6, "A1:HB2129", "Vehicles Operated in Maximum Service") %>% 
  gather(key = "Date", value = UPTs, 
         -`5 digit NTD ID`, 
         -`4 digit NTD ID`, 
         -Agency, 
         -Active, 
         -`Reporter Type`, 
         -UZA, 
         -`UZA Name`, 
         -Modes, 
         -TOS)

```
